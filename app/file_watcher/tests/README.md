# Интеграционные тесты file-watcher

## Описание

Автоматические тесты проверяют корректность работы file-watcher в различных сценариях.

## Покрываемые сценарии

### ✅ Тест 1: Добавление файла
- Создаётся новый файл → `status=added`

### ✅ Тест 2: Изменение файла
- Файл добавляется → `status=added`
- Содержимое изменяется → `status=updated`

### ✅ Тест 3: Удаление файла
- Файл добавляется → `status=added`
- Файл удаляется с диска → `status=deleted`

### ✅ Тест 4: Сложный жизненный цикл
Проверяет переходы между различными статусами:
1. Добавление → `added`
2. Изменение → `updated`
3. Повторное изменение → `updated` (остаётся)
4. Удаление → `deleted`
5. Повторное добавление → `updated`

### ✅ Тест 5: Работа с несколькими файлами
- Добавляется 3 файла одновременно
- Изменяется один файл
- Удаляется другой файл
- Проверяется что остальные не затронуты

### ✅ Тест 6: Фильтрация по расширениям
- Создаются файлы с разрешёнными расширениями (.txt, .pdf, .docx)
- Создаются файлы с запрещёнными расширениями (.csv, .jpg, .py)
- Проверяется что обрабатываются только разрешённые

### ✅ Тест 7: Переименование с изменением расширения
- Файл с .txt добавляется → `status=added`
- Файл "переименовывается" в .csv (удаляется старый, создаётся новый)
- Старый помечается `deleted`, новый игнорируется

### ✅ Тест 8: Быстрые изменения
- Файл изменяется 4 раза подряд
- Проверяется что каждое изменение обнаруживается

## Запуск тестов

### Вариант 1: Через скрипт
```bash
cd /home/alpaca/alpaca-n8n/file-watcher
./run_tests.sh
```

### Вариант 2: Напрямую в контейнере
```bash
docker exec alpaca-file-watcher python /app/tests/test_integration.py
```

## Требования

- Запущенный контейнер `supabase-db` (для подключения к БД)
- Запущенный контейнер `alpaca-file-watcher`

## Результаты

При успешном выполнении все тесты покажут ✓ и финальное сообщение:
```
РЕЗУЛЬТАТЫ: 8 пройдено, 0 провалено
```

## Структура тестов

```
file-watcher/
├── tests/
│   └── test_integration.py    # Интеграционные тесты
├── run_tests.sh               # Скрипт запуска
└── app/                       # Тестируемый код
    ├── database.py
    ├── scanner.py
    ├── vector_sync.py
    └── main.py
```

## Автоматизация

Можно добавить в CI/CD pipeline:
```yaml
# .github/workflows/test.yml
- name: Run integration tests
  run: |
    docker compose up -d
    docker exec alpaca-file-watcher python /app/tests/test_integration.py
```
