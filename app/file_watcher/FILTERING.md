# Система фильтрации файлов в file-watcher

## Описание

Модуль `file_filter.py` предоставляет гибкую систему фильтрации файлов и папок на основе:
- **Размера файла** (минимум и максимум)
- **Имени файла** (шаблоны исключения)
- **Названия папок** (список исключенных директорий)

## Переменные окружения

### FILE_MIN_SIZE
Минимальный размер файла в байтах. Файлы меньше этого размера игнорируются.

**Значение по умолчанию:** `500` (500 байт)

**Пример:**
```bash
FILE_MIN_SIZE=1024  # Игнорировать файлы меньше 1 КБ
```

### FILE_MAX_SIZE
Максимальный размер файла в байтах. Файлы больше этого размера игнорируются.

**Значение по умолчанию:** `10485760` (10 МБ)

**Пример:**
```bash
FILE_MAX_SIZE=52428800  # Игнорировать файлы больше 50 МБ
```

### EXCLUDED_DIRS
Список папок для игнорирования через запятую. Папки с этими именами будут пропущены при сканировании.

**Значение по умолчанию:** `TMP,temp,cache`

**Пример:**
```bash
EXCLUDED_DIRS=TMP,temp,cache,backup,old_files
```

**Примечание:** Скрытые папки (начинающиеся с `.`) всегда игнорируются автоматически.

### EXCLUDED_PATTERNS
Список шаблонов имен файлов для игнорирования через запятую. Поддерживает glob-шаблоны.

**Значение по умолчанию:** `~*,.*,*.tmp`

**Пример:**
```bash
EXCLUDED_PATTERNS=~*,.*,*.tmp,*.bak,*_backup.*
```

**Поддерживаемые шаблоны:**
- `~*` - все файлы, начинающиеся с `~` (временные файлы Office)
- `.*` - все скрытые файлы (начинающиеся с точки)
- `*.tmp` - все файлы с расширением `.tmp`
- `*.bak` - все файлы с расширением `.bak`
- `*_backup.*` - все файлы, содержащие `_backup` в имени

## Примеры использования

### Конфигурация в docker-compose.yml

```yaml
file-watcher:
  environment:
    # Игнорировать файлы меньше 500 байт
    - FILE_MIN_SIZE=500
    
    # Игнорировать файлы больше 10 МБ
    - FILE_MAX_SIZE=10485760
    
    # Игнорировать папки: TMP, temp, cache
    - EXCLUDED_DIRS=TMP,temp,cache
    
    # Игнорировать файлы: начинающиеся с ~ или ., и с расширением .tmp
    - EXCLUDED_PATTERNS=~*,.*,*.tmp
```

### Использование в коде

```python
from file_filter import FileFilter

# Создание фильтра из переменных окружения
file_filter = FileFilter.from_env()

# Или создание фильтра с явными параметрами
file_filter = FileFilter(
    min_size=500,
    max_size=10 * 1024 * 1024,  # 10 МБ
    excluded_dirs=['TMP', 'temp', 'cache'],
    excluded_patterns=['~*', '.*', '*.tmp']
)

# Проверка файла
from pathlib import Path

file_path = Path('/path/to/file.txt')
if file_filter.should_skip_file(file_path):
    print("Файл будет проигнорирован")
else:
    print("Файл будет обработан")

# Проверка директории
if file_filter.should_skip_directory('TMP'):
    print("Директория будет проигнорирована")
```

## Примеры сценариев

### Сценарий 1: Стандартная обработка документов

Обрабатывать только файлы размером от 1 КБ до 50 МБ, игнорировать временные папки и файлы.

```yaml
FILE_MIN_SIZE=1024
FILE_MAX_SIZE=52428800
EXCLUDED_DIRS=TMP,temp,cache,backup
EXCLUDED_PATTERNS=~*,.*,*.tmp,*.bak
```

### Сценарий 2: Обработка больших файлов

Обрабатывать только большие файлы (от 10 МБ до 100 МБ).

```yaml
FILE_MIN_SIZE=10485760
FILE_MAX_SIZE=104857600
EXCLUDED_DIRS=TMP
EXCLUDED_PATTERNS=~*,.*
```

### Сценарий 3: Обработка всех файлов (минимальная фильтрация)

Обрабатывать почти все файлы, кроме очень маленьких (< 100 байт) и очень больших (> 500 МБ).

```yaml
FILE_MIN_SIZE=100
FILE_MAX_SIZE=524288000
EXCLUDED_DIRS=TMP,.git
EXCLUDED_PATTERNS=~*,.DS_Store
```

## Логика работы

1. **Фильтрация директорий** (`should_skip_directory`):
   - Автоматически пропускаются все скрытые папки (начинающиеся с `.`)
   - Пропускаются папки из списка `EXCLUDED_DIRS`

2. **Фильтрация файлов** (`should_skip_file`):
   - Проверка по шаблонам имени файла (`EXCLUDED_PATTERNS`)
   - Проверка размера файла (должен быть >= `FILE_MIN_SIZE` и <= `FILE_MAX_SIZE`)
   - Файл пропускается, если не проходит хотя бы одну проверку

3. **Оптимизация производительности**:
   - Метод `should_skip_file` может принимать опциональный `stat_result` для избежания повторных системных вызовов
   - Сканер передает уже полученный `stat_info` для оптимизации

## Тестирование

Запуск тестов фильтрации:

```bash
cd /home/alpaca/alpaca-n8n/file-watcher
./run_tests.sh
```

Тесты покрывают:
- ✅ Фильтрацию по минимальному размеру
- ✅ Фильтрацию по максимальному размеру
- ✅ Фильтрацию директорий
- ✅ Фильтрацию по шаблонам имен
- ✅ Создание из переменных окружения
- ✅ Комбинированные фильтры
- ✅ Граничные случаи

## Архитектура

```
file-watcher/
├── app/
│   ├── file_filter.py     # Модуль фильтрации (новый)
│   ├── scanner.py          # Сканер с интеграцией фильтра
│   ├── database.py         # Работа с БД
│   ├── vector_sync.py      # Синхронизация статусов
│   └── main.py             # Основной цикл
└── tests/
    ├── test_file_filter.py      # Тесты фильтрации (новый)
    └── test_integration.py      # Интеграционные тесты
```

## Принципы дизайна

1. **Чистота кода**: Логика фильтрации вынесена в отдельный модуль `file_filter.py`
2. **Гибкость**: Все параметры фильтрации настраиваются через переменные окружения
3. **Тестируемость**: Фильтр можно создавать как из env, так и с явными параметрами
4. **Производительность**: Оптимизирован для минимизации системных вызовов
5. **Расширяемость**: Легко добавить новые типы фильтров
