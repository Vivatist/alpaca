# –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞

> –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ –≤ –Ω–æ–≤–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

---

## üìç –í–ê–ñ–ù–û: –°—Ç–∞—Ä—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –æ—Å—Ç–∞—ë—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º!

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `/home/alpaca/alpaca-n8n`

**–ß—Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
- ‚úÖ **file-watcher** - `/home/alpaca/alpaca-n8n/file-watcher/` - –ü–û–õ–ù–û–°–¢–¨–Æ —Ä–∞–±–æ—á–∏–π, –±—Ä–∞—Ç—å –∫–∞–∫ –µ—Å—Ç—å
- ‚úÖ **parsing** - `/home/alpaca/alpaca-n8n/parsing/` - –ü–û–õ–ù–û–°–¢–¨–Æ —Ä–∞–±–æ—á–∏–π, –±—Ä–∞—Ç—å –∫–∞–∫ –µ—Å—Ç—å
- ‚úÖ **main-loop** - `/home/alpaca/alpaca-n8n/main-loop/` - –ü–û–õ–ù–û–°–¢–¨–Æ —Ä–∞–±–æ—á–∏–π, –±—Ä–∞—Ç—å –∫–∞–∫ –µ—Å—Ç—å
- ‚úÖ **admin-backend** - `/home/alpaca/alpaca-n8n/admin-backend/` - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥–æ—Ç–æ–≤, –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª–∏–∫–æ–º

**–≠—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∏–¥–µ–∞–ª—å–Ω–æ. –ù–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å —Å –Ω—É–ª—è - –±–µ—Ä–∏—Ç–µ –∫–æ–¥ –æ—Ç—Ç—É–¥–∞!**

---

## üéØ –¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞

–°–æ–∑–¥–∞–Ω–∏–µ –º–æ–Ω–æ–ª–∏—Ç–Ω–æ–π RAG (Retrieval-Augmented Generation) —Å–∏—Å—Ç–µ–º—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

---

## üìö –ù–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –æ–ø—ã—Ç –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ —Ö–æ—Ä–æ—à–æ:

1. **File Watcher –ª–æ–≥–∏–∫–∞:**
   - –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ SHA256 hash –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
   - –°—Ç–∞—Ç—É—Å–Ω–∞—è –º–æ–¥–µ–ª—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `status_sync`
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º, —Ä–∞–∑–º–µ—Ä—É, –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º

2. **–ü–∞—Ä—Å–∏–Ω–≥ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:**
   - Unstructured API —Å `hi_res` —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π
   - –≠–≤—Ä–∏—Å—Ç–∏–∫–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≤ markdown
   - Timeout 300 —Å–µ–∫—É–Ω–¥ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
   - OCR –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (rus+eng)

3. **Admin Backend:**
   - REST API –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ file_state –∏ documents
   - –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π dashboard endpoint
   - Healthchecks –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Docker API

4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Ollama:**
   - qwen2.5:14b –¥–ª—è LLM
   - bge-m3 –¥–ª—è embeddings (1024 —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å)
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è GPU: KEEP_ALIVE=-1, NUM_PARALLEL=2

### –ü—Ä–æ–±–ª–µ–º—ã —Å—Ç–∞—Ä–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:

1. **N8N overhead:**
   - –°–ª–æ–∂–Ω–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å workflow
   - –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏
   - –ò–∑–±—ã—Ç–æ—á–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å
   - –ù—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π Redis

2. **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã:**
   - 5 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
   - –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (database.py –≤ –∫–∞–∂–¥–æ–º)
   - Network overhead
   - –°–ª–æ–∂–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

3. **–†–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
   - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ docker-compose
   - –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ settings.py
   - –°–ª–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:

```
–ú–æ–Ω–æ–ª–∏—Ç–Ω–æ–µ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (venv)
    ‚Üì
‚îú‚îÄ‚îÄ API endpoints (FastAPI)
‚îú‚îÄ‚îÄ Background workers (APScheduler)
‚îú‚îÄ‚îÄ Core business logic
‚îî‚îÄ‚îÄ Database (asyncpg)
    
–í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã (Docker):
‚îú‚îÄ‚îÄ Unstructured API
‚îú‚îÄ‚îÄ Ollama (GPU)
‚îú‚îÄ‚îÄ Admin Backend (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
‚îî‚îÄ‚îÄ Supabase (PostgreSQL + pgvector)
```

### –ü–æ—á–µ–º—É —Ç–∞–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:

1. **–ú–æ–Ω–æ–ª–∏—Ç** - –ø—Ä–æ—â–µ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å, –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å, –¥–µ–ø–ª–æ–∏—Ç—å
2. **Venv –≤–º–µ—Å—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞** - –±—ã—Å—Ç—Ä–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞, hot reload
3. **Admin Backend –æ—Ç–¥–µ–ª—å–Ω–æ** - –∏–∑–æ–ª—è—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, Docker API
4. **–í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã –≤ Docker** - –∏–∑–æ–ª—è—Ü–∏—è —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

---

## üóÑÔ∏è –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### file_state (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–æ–≤)
```sql
CREATE TABLE file_state (
    id SERIAL PRIMARY KEY,
    file_path TEXT NOT NULL UNIQUE,
    file_size BIGINT NOT NULL,
    file_hash TEXT,                    -- SHA256
    file_mtime DOUBLE PRECISION,       -- Unix timestamp
    status_sync TEXT DEFAULT 'ok',     -- ok|added|updated|processed|deleted|error
    last_checked TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**–°—Ç–∞—Ç—É—Å—ã status_sync:**
- `ok` - —Ñ–∞–π–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω
- `added` - –Ω–æ–≤—ã–π —Ñ–∞–π–ª, —Ç—Ä–µ–±—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `updated` - —Ñ–∞–π–ª –∏–∑–º–µ–Ω—ë–Ω, —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–æ–±—Ä–∞–±–æ—Ç–∫–∏
- `processed` - —Ñ–∞–π–ª –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–∑–∞–Ω–∏–º–∞–µ—Ç —Å–ª–æ—Ç)
- `deleted` - —Ñ–∞–π–ª —É–¥–∞–ª—ë–Ω —Å –¥–∏—Å–∫–∞
- `error` - –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ

### documents (–≤–µ–∫—Ç–æ—Ä–Ω—ã–µ —á–∞–Ω–∫–∏)
```sql
CREATE TABLE documents (
    id BIGSERIAL PRIMARY KEY,
    file_hash TEXT NOT NULL,
    file_path TEXT NOT NULL,
    chunk_index INTEGER NOT NULL,
    chunk_text TEXT NOT NULL,
    embedding VECTOR(1024),           -- bge-m3 embeddings
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT unique_chunk UNIQUE (file_hash, chunk_index)
);
```

---

## üîÑ Workflow –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### –°—Ç–∞—Ä—ã–π workflow (N8N):
```
Webhook ‚Üí Parse (Unstructured) ‚Üí Chunk ‚Üí Embed (Ollama) ‚Üí Save to DB
```

### –ù–æ–≤—ã–π workflow (Python):
```python
async def process_document(file_path, file_hash):
    # 1. Parse
    text = await parser.parse(file_path)
    
    # 2. Chunk
    chunks = chunker.chunk_text(text, size=1000, overlap=200)
    
    # 3. Embed
    embeddings = await embedder.generate(chunks)
    
    # 4. Save
    await db.save_documents(file_hash, chunks, embeddings)
    
    # 5. Update status
    await db.update_status(file_hash, 'ok')
```

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (settings.py)

### –ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

```python
# File Monitoring
MONITORED_PATH = "/monitored_folder"
ALLOWED_EXTENSIONS = [".docx", ".pdf", ".txt", ".xlsx", ".pptx"]
SCAN_INTERVAL = 20  # —Å–µ–∫—É–Ω–¥—ã
FILE_MIN_SIZE = 500  # –±–∞–π—Ç—ã
FILE_MAX_SIZE = 5_000_000  # 5MB

# RAG
CHUNK_SIZE = 1000  # —Å–∏–º–≤–æ–ª–æ–≤
CHUNK_OVERLAP = 200
TOP_K_RESULTS = 5
SIMILARITY_THRESHOLD = 0.7

# Processing
MAX_CONCURRENT_PROCESSING = 2  # –º–∞–∫—Å–∏–º—É–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫
```

---

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (requirements.txt)

### –û—Å–Ω–æ–≤–Ω—ã–µ:
```
fastapi==0.115.0
uvicorn[standard]==0.31.0
asyncpg==0.30.0
pydantic==2.9.0
pydantic-settings==2.5.0
httpx==0.27.0
apscheduler==3.10.4
python-multipart==0.0.9
```

### –î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:
```
langchain==0.3.0
langchain-text-splitters==0.3.0
```

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
```
pytest==8.3.0
pytest-asyncio==0.24.0
black==24.0.0
ruff==0.6.0
```

### –î–ª—è –º–∏–≥—Ä–∞—Ü–∏–π:
```
alembic==1.13.0
```

---

## üß™ –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

### 1. File Watcher

**–í–ê–ñ–ù–û: –†–∞–±–æ—á–∏–π –∫–æ–¥ –≤ `/home/alpaca/alpaca-n8n/file-watcher/`**

–ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã:
- `app/main.py` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- `app/scanner.py` - –ª–æ–≥–∏–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
- `app/database.py` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ë–î
- `app/file_filter.py` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
- `app/vector_sync.py` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è status_sync

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –µ—Å—Ç—å!** –≠—Ç–æ—Ç –∫–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç.

–ü—Ä–∏–º–µ—Ä –∏–∑ `scanner.py`:
```python
import hashlib
from pathlib import Path

def calculate_hash(file_path: str) -> str:
    """SHA256 hash —Ñ–∞–π–ª–∞"""
    sha256_hash = hashlib.sha256()
    with open(file_path, "rb") as f:
        for byte_block in iter(lambda: f.read(4096), b""):
            sha256_hash.update(byte_block)
    return sha256_hash.hexdigest()

def scan_directory(monitored_path: Path, allowed_extensions: list) -> list:
    """–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π"""
    files = []
    for file_path in monitored_path.rglob('*'):
        if file_path.is_file() and file_path.suffix in allowed_extensions:
            files.append({
                'file_path': str(file_path.relative_to(monitored_path)),
                'file_size': file_path.stat().st_size,
                'file_hash': calculate_hash(str(file_path)),
                'file_mtime': file_path.stat().st_mtime
            })
    return files
```

### 2. Parser

**–í–ê–ñ–ù–û: –†–∞–±–æ—á–∏–π –∫–æ–¥ –≤ `/home/alpaca/alpaca-n8n/parsing/`**

–ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã:
- `app/main.py` - FastAPI —Å–µ—Ä–≤–∏—Å –ø–∞—Ä—Å–∏–Ω–≥–∞
- `Dockerfile` - –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
- `requirements.txt` - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –µ—Å—Ç—å!** FastAPI endpoints –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–µ:
- `POST /parse` - –ø–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–∞ –∏–∑ monitored_folder
- `POST /parse/upload` - –ø–∞—Ä—Å–∏–Ω–≥ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
- `GET /health` - healthcheck

–ü—Ä–∏–º–µ—Ä –∏–∑ `main.py`:
```python
async def parse_document(file_path: str) -> str:
    """–ü–∞—Ä—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ Unstructured API"""
    with open(file_path, 'rb') as f:
        file_content = f.read()
    
    files = {'files': (Path(file_path).name, file_content)}
    data = {
        'strategy': 'hi_res',
        'ocr_languages': 'rus+eng',
        'pdf_infer_table_structure': 'true',
    }
    
    async with httpx.AsyncClient(timeout=300) as client:
        response = await client.post(
            f"{UNSTRUCTURED_URL}/general/v0/general",
            files=files,
            data=data
        )
        result = response.json()
        
        # –°–∫–ª–µ–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å —ç–≤—Ä–∏—Å—Ç–∏–∫–∞–º–∏ –¥–ª—è markdown
        content_parts = []
        for element in result:
            text = element.get('text', '')
            element_type = element.get('type', 'NarrativeText')
            
            if element_type == 'Title':
                content_parts.append(f"\n## {text}\n")
            elif element_type == 'Header':
                content_parts.append(f"\n### {text}\n")
            else:
                content_parts.append(text)
        
        return '\n'.join(content_parts)
```

### 3. Embedder (–Ω–æ–≤–∞—è –ª–æ–≥–∏–∫–∞):

```python
async def generate_embeddings(texts: list[str]) -> list[list[float]]:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ —á–µ—Ä–µ–∑ Ollama bge-m3"""
    embeddings = []
    
    async with httpx.AsyncClient(timeout=120) as client:
        for text in texts:
            response = await client.post(
                f"{OLLAMA_BASE_URL}/api/embeddings",
                json={
                    "model": "bge-m3",
                    "prompt": text
                }
            )
            result = response.json()
            embeddings.append(result['embedding'])
    
    return embeddings
```

### 4. Main Loop

**–í–ê–ñ–ù–û: –†–∞–±–æ—á–∏–π –∫–æ–¥ –≤ `/home/alpaca/alpaca-n8n/main-loop/`**

–ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã:
- `app/main.py` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `app/database.py` - —Ä–∞–±–æ—Ç–∞ —Å –ë–î

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –µ—Å—Ç—å!** –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç.

### 5. Admin Backend

**–í–ê–ñ–ù–û: –†–∞–±–æ—á–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ `/home/alpaca/alpaca-n8n/admin-backend/`**

–ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã:
- `app/main.py` - FastAPI —Å –ø–æ–ª–Ω—ã–º REST API
- `app/database.py` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ë–î
- `Dockerfile` - –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
- `requirements.txt` - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª–∏–∫–æ–º –≤ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç!** –í—Å–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç:
- `/api/dashboard` - –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π dashboard
- `/api/file-state/*` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞–º–∏
- `/api/documents/*` - —Ä–∞–±–æ—Ç–∞ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
- `/api/n8n/*` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å N8N (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å)
- `/health` - healthcheck

### 6. Database Sync

–ü–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ `/home/alpaca/alpaca-n8n/file-watcher/app/database.py`:

```python
def sync_by_hash(disk_files: list) -> dict:
    """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è file_state —Å –¥–∏—Å–∫–æ–º –ø–æ hash"""
    stats = {'added': 0, 'updated': 0, 'unchanged': 0, 'deleted': 0}
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ –ë–î
    db_files = fetch_all("SELECT file_hash, file_path, file_size FROM file_state")
    db_by_hash = {f['file_hash']: f for f in db_files}
    disk_by_hash = {f['file_hash']: f for f in disk_files}
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã —Å –¥–∏—Å–∫–∞
    for file_hash, disk_file in disk_by_hash.items():
        if file_hash not in db_by_hash:
            # –ù–æ–≤—ã–π —Ñ–∞–π–ª
            execute("""
                INSERT INTO file_state (file_path, file_size, file_hash, file_mtime, status_sync)
                VALUES (?, ?, ?, ?, 'added')
            """, disk_file['file_path'], disk_file['file_size'], file_hash, disk_file['file_mtime'])
            stats['added'] += 1
        else:
            db_file = db_by_hash[file_hash]
            if disk_file['file_path'] != db_file['file_path']:
                # –§–∞–π–ª –ø–µ—Ä–µ–º–µ—â—ë–Ω
                execute("UPDATE file_state SET file_path = ? WHERE file_hash = ?", 
                       disk_file['file_path'], file_hash)
                stats['updated'] += 1
            else:
                stats['unchanged'] += 1
    
    # –ü–æ–º–µ—á–∞–µ–º —É–¥–∞–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    for file_hash in db_by_hash:
        if file_hash not in disk_by_hash:
            execute("UPDATE file_state SET status_sync = 'deleted' WHERE file_hash = ?", file_hash)
            stats['deleted'] += 1
    
    return stats
```

---

## üîß –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞

### –ß—Ç–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è `/home/alpaca/alpaca-n8n`:

1. **file-watcher/** ‚Üí `app/core/file_watcher.py` –∏ `app/workers/scheduler.py`
   ```bash
   # –í–∑—è—Ç—å –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:
   # - app/main.py (–æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª)
   # - app/scanner.py (—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)
   # - app/database.py (sync_by_hash –ª–æ–≥–∏–∫–∞)
   # - app/file_filter.py (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è)
   # - app/vector_sync.py (status_sync)
   ```

2. **parsing/** ‚Üí `app/core/parser.py`
   ```bash
   # –í–∑—è—Ç—å –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:
   # - app/main.py (—É–±—Ä–∞—Ç—å FastAPI, –æ—Å—Ç–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É)
   ```

3. **main-loop/** ‚Üí `app/workers/file_processor.py`
   ```bash
   # –í–∑—è—Ç—å –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:
   # - app/main.py (–ª–æ–≥–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏)
   # - app/database.py (–º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å pending files)
   ```

4. **admin-backend/** ‚Üí `docker/admin-backend/`
   ```bash
   # –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª–∏–∫–æ–º:
   cp -r /home/alpaca/alpaca-n8n/admin-backend docker/
   # –¢–æ–ª—å–∫–æ —É–±—Ä–∞—Ç—å N8N endpoints –∏–∑ app/main.py
   ```

### –ù–ï –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å —Å –Ω—É–ª—è! –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥!

---

## üöÄ –ó–∞–ø—É—Å–∫ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞:
```bash
# 1. –°–æ–∑–¥–∞—Ç—å venv
python3.12 -m venv venv
source venv/bin/activate

# 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements.txt

# 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å .env
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å DATABASE_URL –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã
cd docker && docker-compose up -d

# 5. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head

# 6. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### Production:
```bash
# Systemd service
sudo systemctl start alpaca-rag
sudo systemctl enable alpaca-rag

# –õ–æ–≥–∏
journalctl -u alpaca-rag -f
```

---

## üîç Troubleshooting

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **Ollama –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: `curl http://localhost:11434/api/tags`
   - –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª–∏: `ollama pull bge-m3 && ollama pull qwen2.5:14b`

2. **Unstructured timeout:**
   - –£–≤–µ–ª–∏—á–∏—Ç—å UNSTRUCTURED_TIMEOUT
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å 5MB)

3. **pgvector –æ—à–∏–±–∫–∏:**
   - –í–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ: `CREATE EXTENSION IF NOT EXISTS vector;`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å: bge-m3 = 1024

4. **File watcher –Ω–µ –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å MONITORED_PATH
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤ ALLOWED_EXTENSIONS
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (FILE_MIN_SIZE, FILE_MAX_SIZE)

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

1. **file_state —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
   ```sql
   SELECT status_sync, COUNT(*) 
   FROM file_state 
   GROUP BY status_sync;
   ```

2. **documents —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
   ```sql
   SELECT 
       COUNT(*) as total_chunks,
       COUNT(DISTINCT file_hash) as unique_files,
       AVG(array_length(embedding::float[], 1)) as avg_embedding_dim
   FROM documents;
   ```

3. **–û—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
   ```sql
   SELECT file_path, file_size, status_sync, last_checked
   FROM file_state
   WHERE status_sync IN ('added', 'updated')
   ORDER BY last_checked ASC;
   ```

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞

–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ –≤ –Ω–æ–≤–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø—Ä–æ–≤–µ—Ä—å:

- [ ] –ü—Ä–æ—á–∏—Ç–∞–Ω MIGRATION_PLAN.md
- [ ] –ü—Ä–æ—á–∏—Ç–∞–Ω —ç—Ç–æ—Ç AI_CONTEXT.md
- [ ] **–í–ê–ñ–ù–û:** –ó–Ω–∞—é —á—Ç–æ —Å—Ç–∞—Ä—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ `/home/alpaca/alpaca-n8n`
- [ ] **–í–ê–ñ–ù–û:** –ü–æ–Ω–∏–º–∞—é —á—Ç–æ file-watcher, parsing, main-loop, admin-backend - –±—Ä–∞—Ç—å –∫–∞–∫ –µ—Å—Ç—å!
- [ ] –ò–∑—É—á–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ settings.py
- [ ] –ü–æ–Ω—è—Ç–Ω–∞ –ª–æ–≥–∏–∫–∞ status_sync
- [ ] –ü–æ–Ω—è—Ç–µ–Ω workflow –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- [ ] –ó–Ω–∞–∫–æ–º—ã —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∫–æ–¥–∞ –≤—ã—à–µ
- [ ] –ü–æ–Ω—è—Ç–Ω–∞ —Å—Ö–µ–º–∞ –ë–î (file_state + documents)
- [ ] –ò–∑–≤–µ—Å—Ç–Ω—ã –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

---

## üéì –ì–ª–æ—Å—Å–∞—Ä–∏–π

- **file_state** - —Ç–∞–±–ª–∏—Ü–∞ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–æ–≤ (–ø—É—Ç—å, hash, —Ä–∞–∑–º–µ—Ä, —Å—Ç–∞—Ç—É—Å)
- **documents** - —Ç–∞–±–ª–∏—Ü–∞ —Å –≤–µ–∫—Ç–æ—Ä–Ω—ã–º–∏ —á–∞–Ω–∫–∞–º–∏ (—Ç–µ–∫—Å—Ç + embedding)
- **status_sync** - —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞ (ok|added|updated|processed|deleted|error)
- **file_hash** - SHA256 —Ö—ç—à —Ñ–∞–π–ª–∞, –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **chunk** - —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞ (–æ–±—ã—á–Ω–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤ —Å overlap 200)
- **embedding** - –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (bge-m3, —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å 1024)
- **RAG** - Retrieval-Augmented Generation, –ø–æ–∏—Å–∫ + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ LLM
- **Unstructured API** - —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (PDF, DOCX, etc)
- **Ollama** - –ª–æ–∫–∞–ª—å–Ω—ã–π LLM —Å–µ—Ä–≤–µ—Ä (qwen2.5 –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, bge-m3 –¥–ª—è embeddings)

---

**–£–¥–∞—á–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ! üöÄ**
