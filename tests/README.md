# –¢–µ—Å—Ç—ã –¥–ª—è Alpaca Worker

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

- **test_chunker.py** - –¢–µ—Å—Ç—ã –º–æ–¥—É–ª—è —á–∞–Ω–∫–æ–≤–∞–Ω–∏—è (custom_chunker) ‚úÖ 7/7
- **test_parser.py** - –¢–µ—Å—Ç—ã –º–æ–¥—É–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ DOCX (parser_word) ‚úÖ 4/4
- **test_embedder.py** - –¢–µ—Å—Ç—ã –º–æ–¥—É–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–∞ (custom_embedder) ‚úÖ 6/6
- **test_worker_integration.py** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã worker (7 —Ç–µ—Å—Ç–æ–≤)
- **test_worker_pipeline.py** - –¢–µ—Å—Ç—ã –ø–æ–ª–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (5 —Ç–µ—Å—Ç–æ–≤)
- **conftest.py** - Pytest fixtures –∏ —É—Ç–∏–ª–∏—Ç—ã

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
cd /home/alpaca/alpaca
source venv/bin/activate
pip install pytest pytest-mock responses
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
–ò–∑–º–µ–Ω–∏—Ç–µ –≤ `settings.py`:
```python
# Testing
RUN_TESTS_ON_START: bool = True  # –ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç—ã –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º worker
TEST_SUITE: str = "unit"         # unit, integration –∏–ª–∏ all
```

–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ `python main.py` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è —Ç–µ—Å—Ç—ã.

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤—Ä—É—á–Ω—É—é

#### –ß–µ—Ä–µ–∑ runner.py (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
```bash
python tests/runner.py --suite unit
python tests/runner.py --suite integration
python tests/runner.py --suite all -v
```

#### –ù–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ pytest
```bash
pytest tests/test_chunker.py tests/test_parser.py tests/test_embedder.py -v
pytest tests/ -v
pytest tests/test_chunker.py::TestChunking::test_chunking_simple_text -v
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ Unit-—Ç–µ—Å—Ç—ã (17/17 passed)

#### –ß–∞–Ω–∫–æ–≤–∞–Ω–∏–µ (test_chunker.py) - 7/7 ‚úÖ
- ‚úÖ test_chunking_simple_text - –ü—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ test_chunking_long_text - –î–ª–∏–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- ‚úÖ test_chunking_empty_text - –ü—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç []
- ‚úÖ test_chunking_whitespace_only - –ü—Ä–æ–±–µ–ª—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è
- ‚úÖ test_chunking_single_long_paragraph - –î–ª–∏–Ω–Ω—ã–µ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- ‚úÖ test_chunking_preserves_content - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- ‚úÖ test_chunking_multiple_newlines - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ \n –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

#### –ü–∞—Ä—Å–∏–Ω–≥ DOCX (test_parser.py) - 4/4 ‚úÖ
- ‚úÖ test_parse_docx_file - –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∞–ª—å–Ω–æ–≥–æ DOCX
- ‚úÖ test_parse_nonexistent_file - –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞
- ‚úÖ test_parse_empty_docx - –ü—É—Å—Ç–æ–π DOCX –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
- ‚úÖ test_parse_docx_with_multiple_paragraphs - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤

#### –≠–º–±–µ–¥–¥–∏–Ω–≥ (test_embedder.py) - 6/6 ‚úÖ
- ‚úÖ test_embedding_success - –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (mock Ollama)
- ‚úÖ test_embedding_empty_chunks - –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ ‚Üí 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- ‚úÖ test_embedding_ollama_error - –û—à–∏–±–∫–∞ API –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ test_embedding_partial_success - –ß–∞—Å—Ç–∏—á–Ω–∞—è —É—Å–ø–µ—à–Ω–æ—Å—Ç—å (2/3)
- ‚úÖ test_embedding_no_embedding_in_response - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ embedding –≤ –æ—Ç–≤–µ—Ç–µ
- ‚úÖ test_embedding_database_commit - –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î

### üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (—Ç—Ä–µ–±—É—é—Ç –ë–î)

–≠—Ç–∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–∞–±–æ—Ç—É —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î –∏ —Ç—Ä–µ–±—É—é—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:
- PostgreSQL (172.17.0.1:54322)
- Ollama (localhost:11434) - –º–æ–∂–Ω–æ mock'–∞—Ç—å

**test_worker_integration.py** - 7 —Ç–µ—Å—Ç–æ–≤:
- –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏ —á–∞–Ω–∫–æ–≤
- –ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –†–∞–∑–ª–∏—á–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã —Ñ–∞–π–ª–æ–≤ (added/deleted/updated)

**test_worker_pipeline.py** - 5 —Ç–µ—Å—Ç–æ–≤:
- DOCX ‚Üí –ø–∞—Ä—Å–∏–Ω–≥ ‚Üí —á–∞–Ω–∫–∏ ‚Üí —ç–º–±–µ–¥–¥–∏–Ω–≥–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
- –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

## –ü–æ–∫—Ä—ã—Ç–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

### ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫—Ä—ã—Ç–æ
- –ß–∞–Ω–∫–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (custom_chunker)
- –ü–∞—Ä—Å–∏–Ω–≥ DOCX (parser_word)
- –°–æ–∑–¥–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (custom_embedder)

### ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ –ø–æ–∫—Ä—ã—Ç–æ
- –ü–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Ç—Ä–µ–±—É–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ —Ñ–∞–π–ª–æ–≤
- –†–∞–±–æ—Ç–∞ —Å –ë–î

### ‚ùå –ù–µ –ø–æ–∫—Ä—ã—Ç–æ
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (ThreadPoolExecutor)
- –°–µ–º–∞—Ñ–æ—Ä—ã (PARSE_SEMAPHORE, EMBED_SEMAPHORE)
- API filewatcher (/api/next-file)
- –§—É–Ω–∫—Ü–∏—è run_worker (–æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª)

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- ‚úÖ Unit-—Ç–µ—Å—Ç—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç mocks
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î
- ‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã —Ç—Ä–µ–±—É—é—Ç —Ä–µ–∞–ª—å–Ω–æ–π –ë–î
- ‚ö†Ô∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –º–æ–≥—É—Ç –∏–∑–º–µ–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î
- üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ fixtures –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤:

1. **Unit-—Ç–µ—Å—Ç—ã**: –î–æ–±–∞–≤—å—Ç–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π test_*.py
2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ test_worker_integration.py
3. **Fixtures**: –î–æ–±–∞–≤—å—Ç–µ –≤ conftest.py
4. **Mock API**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ @responses.activate –∏ responses.add()

–ü—Ä–∏–º–µ—Ä:
```python
@responses.activate
def test_my_feature(test_db):
    responses.add(
        responses.POST,
        "http://api.example.com/endpoint",
        json={'result': 'success'},
        status=200
    )
    # –í–∞—à —Ç–µ—Å—Ç
```
