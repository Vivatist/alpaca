# Word Parser – актуальный процесс

Этот документ описывает реальную последовательность действий класса `WordParser`
(`app/parsers/word_parser_module/word_parser.py`) в текущем воркер-пайплайне ALPACA.
Парсер возвращает **Markdown‑текст** (строка). YAML Header и прочая упаковка выполняются
дальше в ingest‑pipeline (chunking → embeddings).

## 1. Нормализация формата

- Вход: `.docx` (основной кейс) или legacy `.doc`.
- Для `.doc` запускаем LibreOffice в headless режиме (`libreoffice --convert-to docx`).
- Конвертированный `.docx` живёт во временной директории `alpaca_doc_convert_*` и
    обязательно удаляется в `finally`.

## 2. Общие и специфичные метаданные

- `_add_common_metadata()` добавляет базовую информацию (имя файла, хэш, размеры).
- `extract_word_metadata()` (python-docx) вычисляет страницы, параграфы, таблицы,
    изображения, автора. Эти данные пока не возвращаются наружу, но оставлены для
    будущей интеграции в YAML.

## 3. Основной парсинг (Markitdown)

1. Пытаемся прогнать документ через Markitdown. Возвращаем `result.text_content`.
2. При ошибке или пустом результате включается `fallback_parse()` (python-docx):
     - обход `doc.element.body` (CT_P/CT_Tbl);
     - Markdown‑представление заголовков и таблиц.

## 4. OCR изображений (опционально)

- Управляется параметрами конструктора `WordParser(enable_ocr=True, ocr_strategy="auto")`.
- `extract_images_from_docx()` достаёт бинарные изображения через `doc.part.rels` и
    сохраняет их во временную директорию `alpaca_word_images_*`.
- WMF/EMF конвертируются в PNG (ImageMagick → PIL → PDF fallback).
- Для каждого изображения вызываем `partition_image()` (`unstructured`) с языками
    `rus`+`eng`. Полученный текст **подставляется на место** Markdown‑вставки вида
    `![](data:image/...)`. Дополнительные заголовки «Изображение N» не добавляются –
    текст интегрируется напрямую в поток документа.
- Временные файлы изображений удаляются после обработки.

## 5. Результат

- Возвращается чистый Markdown (`str`).
- Пустой или пробельный результат считается ошибкой на уровне ingest-пайплайна и
    приводит к `mark_as_error`.
- YAML/metadata сохраняются в БД именно там, где выполняется Chunking/Embedding.

## 6. Зависимости и ошибки

| Компонент                    | Назначение                                 | Поведение при сбое                 |
|-----------------------------|---------------------------------------------|------------------------------------|
| LibreOffice                 | `.doc` → `.docx`                            | Парсинг продолжается по оригиналу  |
| Markitdown                  | Основной Markdown                           | Fallback на python-docx            |
| python-docx                 | Метаданные, fallback, извлечение изображений| Ошибки логируются, процесс идёт далее |
| ImageMagick / PIL / pdf2image| WMF/EMF → PNG                               | Пропускаем конкретное изображение   |
| unstructured.partition_image| OCR                                         | Если недоступно → изображения остаются как есть |

## 7. Типовые сценарии

1. **Чистый `.docx` без картинок** – ≈0.5‑1 с, Markitdown → результат.
2. **`.docx` с печатями** – +2‑5 с на каждую картинку из-за OCR.
3. **Старый `.doc`** – LibreOffice (+5‑15 с) → Markitdown.

## 8. Что ещё планируется

- Добавить сохранение Word‑метаданных в YAML перед chunking.
- Передавать информацию о количестве успешно обработанных изображений в ingest логах.
- Вынести пути временных директорий в конфигурацию (сейчас они жёстко заданы в коде).

Документ последовательно отражает всю логику, которая реально присутствует в
`word_parser.py`, и может использоваться как reference при правках кода или
инфраструктуры вокруг Word‑парсера.
