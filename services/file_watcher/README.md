# File Watcher Container

–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.

## –û–ø–∏—Å–∞–Ω–∏–µ

File Watcher —Å–∫–∞–Ω–∏—Ä—É–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—É—é –ø–∞–ø–∫—É –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö PostgreSQL. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ RAG –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ.

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

- ‚úÖ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ SHA256 —Ö–µ—à–µ–π —Ñ–∞–π–ª–æ–≤
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ö–µ—à–∞–º
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤: `added`, `updated`, `deleted`, `ok`
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é, —Ä–∞–∑–º–µ—Ä—É –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º
- ‚úÖ Graceful shutdown –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ SIGTERM/SIGINT

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

- `DATABASE_URL` - URL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL (—Ñ–æ—Ä–º–∞—Ç: `postgresql://user:pass@host:port/db`)

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------------|----------|
| `FILES_TABLE_NAME` | `files` | –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤ |
| `MONITORED_PATH` | `/monitored_folder` | –ü—É—Ç—å –∫ –Ω–∞–±–ª—é–¥–∞–µ–º–æ–π –ø–∞–ø–∫–µ |
| `SCAN_INTERVAL_SECONDS` | `10` | –ü–µ—Ä–∏–æ–¥ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö |
| `ALLOWED_EXTENSIONS` | `.docx,.pdf,.txt` | –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é) |
| `FILE_MIN_SIZE` | `100` | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –±–∞–π—Ç–∞—Ö |
| `FILE_MAX_SIZE` | `10485760` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (10 –ú–ë) |
| `EXCLUDED_DIRS` | `TMP` | –ò—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é) |
| `EXCLUDED_PATTERNS` | `~*,.*` | –ò—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é) |
| `LOG_LEVEL` | `INFO` | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è |

## –ó–∞–ø—É—Å–∫

### –° Docker Compose

```bash
cd docker
docker-compose up filewatcher
```

### Standalone

```bash
docker build -t alpaca-filewatcher -f docker/Dockerfile.filewatcher .
docker run -d \
  --name filewatcher \
  -v /path/to/monitored:/monitored_folder:ro \
  -e DATABASE_URL=postgresql://user:pass@host:port/db \
  -e SCAN_INTERVAL_SECONDS=10 \
  alpaca-filewatcher
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
```bash
docker logs -f filewatcher
```

–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
```
2025-11-24 00:00:00 | INFO | file-watcher - File Watcher Service Starting
2025-11-24 00:00:00 | INFO | file-watcher - Monitored path: /monitored_folder
2025-11-24 00:00:00 | INFO | file-watcher - Scan interval: 10s
2025-11-24 00:00:10 | INFO | file-watcher - üîç Starting scan iteration #1
2025-11-24 00:00:10 | INFO | file-watcher - ‚úÖ Scan complete | total=5, +2, ~1, -0, ok=2
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  File System     ‚îÇ
‚îÇ  /monitored      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Scanner        ‚îÇ ‚Üê –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
‚îÇ   + HashCalculate‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Database       ‚îÇ ‚Üê –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ —Ö–µ—à–∞–º
‚îÇ   (PostgreSQL)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –¶–∏–∫–ª —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

1. **Scan** - —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
2. **Hash** - –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ SHA256 –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
3. **Sync** - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ë–î –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤:
   - –§–∞–π–ª –Ω–æ–≤—ã–π ‚Üí `status_sync = 'added'`
   - –•–µ—à –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Üí `status_sync = 'updated'`
   - –§–∞–π–ª —É–¥–∞–ª–µ–Ω ‚Üí `status_sync = 'deleted'`
   - –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Üí `status_sync = 'ok'`
4. **Sleep** - –æ–∂–∏–¥–∞–Ω–∏–µ `SCAN_INTERVAL_SECONDS`
5. –ü–æ–≤—Ç–æ—Ä —Ü–∏–∫–ª–∞

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

–ï—Å–ª–∏ —Ñ–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞ –¥–∏—Å–∫–µ –Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –ë–î, –æ–Ω –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `deleted` **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞** (–≤–∫–ª—é—á–∞—è `error`, `processed`). –ò—Å–∫–ª—é—á–µ–Ω–∏–µ - —É–∂–µ –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ `deleted`.

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –ü–∞–ø–∫–∞ –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ **read-only** (`ro`)
- ‚úÖ Graceful shutdown –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
- ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ç–∏ (—Ç–æ–ª—å–∫–æ –ë–î)

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è **–ø–æ—Å–ª–µ Supabase**:

```yaml
depends_on:
  - prefect  # –∏–ª–∏ supabase
```

## Troubleshooting

### –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. `DATABASE_URL` –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞
3. –ü–∞–ø–∫–∞ `/monitored_folder` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞

### –§–∞–π–ª—ã –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –≤ `ALLOWED_EXTENSIONS`
2. –†–∞–∑–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö `FILE_MIN_SIZE` - `FILE_MAX_SIZE`
3. –§–∞–π–ª—ã –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –ø–æ–¥ `EXCLUDED_PATTERNS`
4. –õ–æ–≥–∏: `docker logs filewatcher`

### –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞

–£–≤–µ–ª–∏—á—å—Ç–µ `SCAN_INTERVAL_SECONDS` –∏–ª–∏ —É–º–µ–Ω—å—à–∏—Ç–µ `FILE_MAX_SIZE`.
