"""
Конфигурация Complex Agent Backend.

Все константы и веса для реранкинга, категорий и поиска.
"""
from typing import List, Dict

# === Категории документов ===

DOCUMENT_CATEGORIES: List[str] = [
    "Договор подряда",
    "Договор купли-продажи",
    "Трудовой договор",
    "Протокол, меморандум",
    "Доверенность",
    "Акт выполненных работ",
    "Счет-фактура, счет",
    "Техническая документация",
    "Презентация",
    "Письмо",
    "Бухгалтерская документация",
    "Инструкция, регламент",
    "Статья, публикация, книга",
    "Прочее",
]

# Приоритет категорий для реранкинга (чем выше индекс - тем выше приоритет)
# Договоры и акты важнее писем и презентаций
CATEGORY_PRIORITY: Dict[str, float] = {
    "Договор подряда": 1.0,
    "Договор купли-продажи": 1.0,
    "Трудовой договор": 0.95,
    "Акт выполненных работ": 0.9,
    "Счет-фактура, счет": 0.85,
    "Доверенность": 0.8,
    "Протокол, меморандум": 0.75,
    "Техническая документация": 0.7,
    "Бухгалтерская документация": 0.65,
    "Инструкция, регламент": 0.6,
    "Письмо": 0.5,
    "Презентация": 0.45,
    "Статья, публикация, книга": 0.4,
    "Прочее": 0.3,
}


# === Веса реранкинга ===

# Вес similarity от vector search (0-1)
RERANK_SIMILARITY_WEIGHT = 0.5

# Вес свежести документа (0-1)
RERANK_FRESHNESS_WEIGHT = 0.3

# Вес приоритета категории (0-1)
RERANK_CATEGORY_WEIGHT = 0.2

# Сумма должна быть = 1.0
assert abs(RERANK_SIMILARITY_WEIGHT + RERANK_FRESHNESS_WEIGHT + RERANK_CATEGORY_WEIGHT - 1.0) < 0.001


# === Robust Search ===

# Минимальное количество результатов для success
MIN_RESULTS_THRESHOLD = 3

# Максимум итераций поиска
MAX_SEARCH_ITERATIONS = 3

# Расширение диапазона дат при retry (в днях)
DATE_RANGE_EXPANSION_DAYS = 365

# Лимит результатов по умолчанию
DEFAULT_SEARCH_LIMIT = 10


# === Structured Search ===

# Score для результатов structured search (без embedding similarity)
STRUCTURED_SEARCH_BASE_SCORE = 0.5


# === Freshness (дата документа) ===

# Максимальный возраст документа в днях для нормализации freshness
# Документы старше этого получают freshness = 0
MAX_DOCUMENT_AGE_DAYS = 365 * 3  # 3 года


# === LLM Extraction ===

# Системный промпт для извлечения метаданных из запроса
QUERY_EXTRACTION_PROMPT = """Проанализируй запрос пользователя и извлеки структурированные фильтры для поиска документов.

КАТЕГОРИИ документов (используй ТОЧНОЕ название, если запрос явно указывает на тип документа):
{categories}

ПРАВИЛА определения категории:
- "договор", "контракт", "соглашение" → определи ТИП договора (подряда, купли-продажи, трудовой)
- "договор подряда", "подрядный договор", "договор на работы/услуги" → "Договор подряда"
- "договор купли-продажи", "договор поставки", "купля-продажа" → "Договор купли-продажи"
- "трудовой договор", "контракт с сотрудником" → "Трудовой договор"
- "акт", "акт выполненных работ", "акт приёмки" → "Акт выполненных работ"
- "счёт", "счёт-фактура", "инвойс" → "Счет-фактура, счет"
- "протокол", "меморандум", "протокол совещания" → "Протокол, меморандум"
- "доверенность" → "Доверенность"
- "техническая документация", "ТЗ", "спецификация" → "Техническая документация"
- "презентация", "слайды" → "Презентация"
- "письмо", "обращение", "запрос" → "Письмо"
- Если тип документа неясен или общий ("документы", "файлы") → category: null

ПРАВИЛА для entity:
- Извлеки название организации или ФИО человека в ИМЕНИТЕЛЬНОМ падеже
- "договор с Акпаном" → entity: "Акпан"
- "документы компании Георезонанс" → entity: "Георезонанс"
- "контракт Иванова" → entity: "Иванов"
- Убери склонение: "АкпанОМ" → "Акпан", "Георезонансом" → "Георезонанс"

Верни JSON:
- category: строка (ТОЧНОЕ название из списка) или null
- entity: строка (организация/человек в именительном падеже) или null
- keywords: массив строк (дополнительные ключевые слова) или null
- date_from: строка YYYY-MM-DD или null
- date_to: строка YYYY-MM-DD или null

Запрос: {query}

Ответь ТОЛЬКО валидным JSON:"""


# === Agent System Prompt ===

AGENT_SYSTEM_PROMPT = """Ты — корпоративный LLM-ассистент компании ALPACA.
Твоя задача — найти документы максимально точно, используя инструмент search_documents.

Используй фильтры, если в запросе присутствуют:
- компании или ФИО → entity (название организации или имя человека)
- упоминание типа документа → category (сопоставь с категориями)
- ключевые слова → keywords
- даты → date_from/date_to

Стратегия поиска:
1. Всегда сначала попробуй structured + semantic search с фильтрами
2. Если мало результатов — система автоматически ослабит фильтры
3. Система покажет пользователю промежуточные сообщения о ходе поиска

Правила ответа:
- НЕ выдумывай информацию о документах
- НЕ перечисляй названия файлов в ответе — пользователь видит их как ссылки
- Отвечай на русском языке, кратко и по делу
- Давай конкретный ответ на основе содержимого документов
- Никогда не выводи внутренние данные инструментов или фильтры"""


# === Query Classification Prompt ===

QUERY_CLASSIFICATION_PROMPT = """Определи, требует ли запрос пользователя поиска по корпоративным документам.

ТРЕБУЕТ ПОИСКА (ответь "search"):
- Вопросы о договорах, контрактах, соглашениях
- Вопросы о конкретных компаниях или людях
- Запросы на поиск документов, файлов
- Вопросы о корпоративной информации
- "Найди договор с...", "Покажи документы...", "Что известно о компании..."

НЕ ТРЕБУЕТ ПОИСКА (ответь "direct"):
- Общие вопросы (математика, факты, определения)
- Приветствия, благодарности
- Вопросы о возможностях ассистента
- Программирование, код
- Перевод текста
- Креативные задачи (написать текст, придумать)
- "2+2", "Что такое...", "Переведи...", "Напиши код..."

Запрос: {query}

Ответь ТОЛЬКО одним словом: search или direct"""


# === Direct Answer System Prompt ===

DIRECT_ANSWER_SYSTEM_PROMPT = """Ты — корпоративный ассистент ALPACA.
Отвечай кратко, точно и по делу на русском языке.
Если не знаешь ответа — честно скажи об этом."""
