# Complex Agent Backend

Agentic RAG Ñ robust search, Ñ€ĞµÑ€Ğ°Ğ½ĞºĞ¸Ğ½Ğ³Ğ¾Ğ¼ Ğ¸ streaming callbacks.

## ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
User Query
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ComplexAgentBackend          â”‚
â”‚                                        â”‚
â”‚  1. Extract filters (LLM)              â”‚
â”‚     - category, company, person        â”‚
â”‚     - keywords, date_from, date_to     â”‚
â”‚                                        â”‚
â”‚  2. Robust Search (3 Ğ¸Ñ‚ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸)         â”‚
â”‚     Iteration 1: Strict filters        â”‚
â”‚     Iteration 2: Relaxed filters       â”‚
â”‚     Iteration 3: Semantic only         â”‚
â”‚                                        â”‚
â”‚  3. Combined Reranking                 â”‚
â”‚     - similarity (50%)                 â”‚
â”‚     - freshness (30%)                  â”‚
â”‚     - category priority (20%)          â”‚
â”‚                                        â”‚
â”‚  4. Stream Generate (Ollama)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ĞœĞ¾Ğ´ÑƒĞ»Ğ¸

| Ğ¤Ğ°Ğ¹Ğ» | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------|----------|
| `config.py` | ĞšĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ñ‹, ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸, Ğ²ĞµÑĞ° Ñ€ĞµÑ€Ğ°Ğ½ĞºĞ¸Ğ½Ğ³Ğ° |
| `schemas.py` | Pydantic Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ (SearchHit, SearchResult, etc.) |
| `vector_store.py` | VectorStoreAdapter (semantic + structured search) |
| `reranker.py` | ĞšĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ€ĞµÑ€Ğ°Ğ½ĞºĞµÑ€ |
| `robust_search.py` | Ğ˜Ñ‚ĞµÑ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº Ñ Ğ¾ÑĞ»Ğ°Ğ±Ğ»ĞµĞ½Ğ¸ĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² |
| `search_tool.py` | LangChain Tool Ğ´Ğ»Ñ Ğ°Ğ³ĞµĞ½Ñ‚Ğ° |
| `agent.py` | RagAgent â€” Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° |
| `backend.py` | ChatBackend Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ |

## Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### ĞĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ

Ğ’ `docker-compose.yml`:

```yaml
chat-backend:
  environment:
    - CHAT_BACKEND=complex_agent
```

### API

Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ‡ĞµÑ€ĞµĞ· ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ `/api/chat/stream` endpoint.

## Robust Search

### Ğ˜Ñ‚ĞµÑ€Ğ°Ñ†Ğ¸Ñ 1: Strict

Ğ’ÑĞµ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑÑÑ‚ÑÑ ĞºĞ°Ğº ĞµÑÑ‚ÑŒ:
- Semantic search Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼Ğ¸
- Structured search Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼Ğ¸
- Merge + Rerank

### Ğ˜Ñ‚ĞµÑ€Ğ°Ñ†Ğ¸Ñ 2: Relaxed

Ğ•ÑĞ»Ğ¸ < 3 Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ², Ğ¾ÑĞ»Ğ°Ğ±Ğ»ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñƒ:
1. Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ `keywords`
2. Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ `company`, `person`
3. Ğ Ğ°ÑÑˆĞ¸Ñ€ÑĞµĞ¼ `date_from/date_to` Ğ½Ğ° Â±1 Ğ³Ğ¾Ğ´
4. Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ `category` (Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ resort)

### Ğ˜Ñ‚ĞµÑ€Ğ°Ñ†Ğ¸Ñ 3: Fallback

Ğ§Ğ¸ÑÑ‚Ñ‹Ğ¹ semantic search Ğ±ĞµĞ· Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ².

## Ğ ĞµÑ€Ğ°Ğ½ĞºĞ¸Ğ½Ğ³

Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ° Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ score:

```
final_score = (
    0.5 * normalized_similarity +
    0.3 * freshness_score +
    0.2 * category_boost
)
```

### Freshness

- Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ = 1.0
- 3 Ğ³Ğ¾Ğ´Ğ° Ğ½Ğ°Ğ·Ğ°Ğ´ = 0.0
- Ğ›Ğ¸Ğ½ĞµĞ¹Ğ½Ğ°Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ¿Ğ¾Ğ»ÑÑ†Ğ¸Ñ

### Category Boost

ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñ‹ Ğ² `config.py`:
- Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ñ‹: 1.0
- ĞĞºÑ‚Ñ‹: 0.9
- ĞŸĞ¸ÑÑŒĞ¼Ğ°: 0.5
- ĞŸÑ€Ğ¾Ñ‡ĞµĞµ: 0.3

## Streaming

Backend Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼ĞµĞ¶ÑƒÑ‚Ğ¾Ñ‡Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· `tool_call` events:

```
ğŸ” ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒÑ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ...
ğŸ” Ğ˜Ñ‰Ñƒ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ Â«Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´Ğ°Â»...
ğŸ“‹ Ğ£Ğ±Ğ¸Ñ€Ğ°Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğ¼ ÑĞ»Ğ¾Ğ²Ğ°Ğ¼...
âœ… ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ 5 Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
ğŸ’­ Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒÑ Ğ¾Ñ‚Ğ²ĞµÑ‚...
```

## ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²

```python
DOCUMENT_CATEGORIES = [
    "Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´Ğ°",
    "Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ ĞºÑƒĞ¿Ğ»Ğ¸-Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸",
    "Ğ¢Ñ€ÑƒĞ´Ğ¾Ğ²Ğ¾Ğ¹ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€",
    "ĞŸÑ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ», Ğ¼ĞµĞ¼Ğ¾Ñ€Ğ°Ğ½Ğ´ÑƒĞ¼",
    "Ğ”Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ",
    "ĞĞºÑ‚ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ñ… Ñ€Ğ°Ğ±Ğ¾Ñ‚",
    "Ğ¡Ñ‡ĞµÑ‚-Ñ„Ğ°ĞºÑ‚ÑƒÑ€Ğ°, ÑÑ‡ĞµÑ‚",
    "Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ",
    "ĞŸÑ€ĞµĞ·ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ",
    "ĞŸĞ¸ÑÑŒĞ¼Ğ¾",
    "Ğ‘ÑƒÑ…Ğ³Ğ°Ğ»Ñ‚ĞµÑ€ÑĞºĞ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ",
    "Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ, Ñ€ĞµĞ³Ğ»Ğ°Ğ¼ĞµĞ½Ñ‚",
    "Ğ¡Ñ‚Ğ°Ñ‚ÑŒÑ, Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ, ĞºĞ½Ğ¸Ğ³Ğ°",
    "ĞŸÑ€Ğ¾Ñ‡ĞµĞµ",
]
```

## ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ

Ğ’ÑĞµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ² `config.py`:

| ĞšĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ğ° | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|-----------|----------|----------|
| `RERANK_SIMILARITY_WEIGHT` | 0.5 | Ğ’ĞµÑ similarity |
| `RERANK_FRESHNESS_WEIGHT` | 0.3 | Ğ’ĞµÑ ÑĞ²ĞµĞ¶ĞµÑÑ‚Ğ¸ |
| `RERANK_CATEGORY_WEIGHT` | 0.2 | Ğ’ĞµÑ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ |
| `MIN_RESULTS_THRESHOLD` | 3 | ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ success |
| `MAX_SEARCH_ITERATIONS` | 3 | ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ¸Ñ‚ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ |
| `DATE_RANGE_EXPANSION_DAYS` | 365 | Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° Ğ´Ğ°Ñ‚ |
