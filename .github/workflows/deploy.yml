# CI/CD Pipeline –¥–ª—è ALPACA
# 
# –¢—Ä–∏–≥–≥–µ—Ä: push –≤ main
# –î–µ–π—Å—Ç–≤–∏—è:
#   1. Git pull –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
#   2. –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
#
# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
#   1. Self-hosted runner –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
#   2. .env —Ñ–∞–π–ª –≤ ~/alpaca/services —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏

name: Deploy to Server

on:
  push:
    branches: [main]
  
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Pull latest code
        run: |
          cd ~/alpaca
          git fetch origin main
          git reset --hard origin/main
          echo "‚úÖ Code updated to $(git rev-parse --short HEAD)"
      
      - name: Rebuild and restart services
        run: |
          cd ~/alpaca/services
          echo "üîÑ Rebuilding containers..."
          docker compose down
          docker compose build --no-cache
          docker compose up -d
          echo "‚úÖ Services restarted"
      
      - name: Cleanup old images
        run: docker image prune -f
      
      - name: Health check
        run: |
          echo "‚è≥ Waiting for services to start..."
          sleep 15
          
          echo "üîç Checking admin-backend..."
          curl -sf http://localhost:8080/health && echo " ‚úÖ OK" || echo " ‚ùå FAILED"
          
          echo "üîç Checking chat-backend..."
          curl -sf http://localhost:8082/health && echo " ‚úÖ OK" || echo " ‚ùå FAILED"
          
          echo "üîç Checking filewatcher..."
          curl -sf http://localhost:8081/health && echo " ‚úÖ OK" || echo " ‚ùå FAILED"
          
          echo "üîç Checking mcp-server..."
          curl -sf http://localhost:8083/docs && echo " ‚úÖ OK" || echo " ‚ùå FAILED"
