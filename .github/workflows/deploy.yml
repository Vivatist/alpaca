# CI/CD Pipeline –¥–ª—è ALPACA
# 
# –¢—Ä–∏–≥–≥–µ—Ä: push –≤ main
# –î–µ–π—Å—Ç–≤–∏—è:
#   1. Git pull –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
#   2. –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
#
# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
#   1. Self-hosted runner –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
#   2. .env —Ñ–∞–π–ª –≤ ~/alpaca/services —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏

name: Deploy to Server

on:
  push:
    branches: [main]
  
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Pull latest code
        run: |
          cd ~/alpaca
          git fetch origin main
          git reset --hard origin/main
          echo "‚úÖ Code updated to $(git rev-parse --short HEAD)"
      
      - name: Check Supabase and fix DATABASE_URL
        run: |
          cd ~/alpaca/services
          
          echo "üìä Supabase containers:"
          docker ps --format "table {{.Names}}\t{{.Ports}}" | grep -i supabase || true
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Å–µ—Ç—å supabase_default
          if docker network ls | grep -q supabase_default; then
            echo "‚úÖ Found supabase_default network - will use it"
            # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º DATABASE_URL –Ω–∞ supabase-db:5432 (–≤–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏)
            if [ -f .env ]; then
              sed -i 's|@172.17.0.1:[0-9]*|@supabase-db:5432|g' .env
              echo "‚úÖ DATABASE_URL set to supabase-db:5432 (internal network)"
            fi
          else
            echo "‚ö†Ô∏è supabase_default network not found"
          fi
          
          echo "üìã Current .env configuration:"
          grep -E "^(DATABASE_URL|OLLAMA_BASE_URL)=" .env | sed 's/:[^:@]*@/:***@/' || echo "No .env found"
      
      - name: Rebuild and restart services
        run: |
          cd ~/alpaca/services
          echo "üîÑ Rebuilding containers..."
          docker compose down
          docker compose build --no-cache
          
          # –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º docker-compose.server.yml –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ç–∏ Supabase
          if docker network ls | grep -q supabase_default; then
            echo "üîó Using supabase_default network"
            docker compose -f docker-compose.yml -f docker-compose.server.yml up -d
          else
            echo "üîó Using standalone network"
            docker compose up -d
          fi
          echo "‚úÖ Services restarted"
      
      - name: Show container status
        run: |
          echo "üìä Container status:"
          docker ps --format "table {{.Names}}\t{{.Status}}" | grep -E "alpaca|supabase" || true
      
      - name: Cleanup old images
        run: docker image prune -f
      
      - name: Health check
        run: |
          echo "‚è≥ Waiting for services to start..."
          sleep 15
          
          FAILED=0
          
          echo "üîç Checking admin-backend..."
          if curl -sf http://localhost:8080/health > /tmp/health_admin.json 2>&1; then
            echo " ‚úÖ OK"
          else
            echo " ‚ùå FAILED"
            docker logs alpaca-admin-backend-1 --tail 20 2>&1 || true
            FAILED=1
          fi
          
          echo "üîç Checking chat-backend..."
          if curl -sf http://localhost:8082/health > /tmp/health_chat.json 2>&1; then
            echo " ‚úÖ OK"
          else
            echo " ‚ùå FAILED"
            docker logs alpaca-chat-backend-1 --tail 20 2>&1 || true
            FAILED=1
          fi
          
          echo "üîç Checking filewatcher..."
          if curl -sf http://localhost:8081/health > /tmp/health_fw.json 2>&1; then
            echo " ‚úÖ OK"
          else
            echo " ‚ùå FAILED"
            docker logs alpaca-filewatcher-1 --tail 20 2>&1 || true
            FAILED=1
          fi
          
          echo "üîç Checking mcp-server..."
          if curl -sf http://localhost:8083/docs > /dev/null 2>&1; then
            echo " ‚úÖ OK"
          else
            echo " ‚ùå FAILED"
            docker logs alpaca-mcp-server-1 --tail 20 2>&1 || true
            FAILED=1
          fi
          
          echo ""
          echo "üìä Container status:"
          docker ps --format "table {{.Names}}\t{{.Status}}" | grep alpaca || true
          
          if [ $FAILED -eq 1 ]; then
            echo "‚ö†Ô∏è Some services failed health check"
            exit 1
          fi
          
          echo "‚úÖ All services healthy!"
