# CI/CD Pipeline –¥–ª—è ALPACA
# 
# –¢—Ä–∏–≥–≥–µ—Ä: push –≤ main
# –î–µ–π—Å—Ç–≤–∏—è:
#   1. Git pull –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
#   2. –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
#
# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
#   1. Self-hosted runner –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
#   2. .env —Ñ–∞–π–ª –≤ ~/alpaca/services —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏

name: Deploy to Server

on:
  push:
    branches: [main]
  
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Pull latest code
        run: |
          cd ~/alpaca
          git fetch origin main
          git reset --hard origin/main
          echo "‚úÖ Code updated to $(git rev-parse --short HEAD)"
      
      - name: Check Supabase and fix DATABASE_URL
        run: |
          cd ~/alpaca/services
          
          echo "üìä Supabase containers:"
          docker ps --format "table {{.Names}}\t{{.Ports}}" | grep -i supabase || true
          
          # –ò—â–µ–º –ø–æ—Ä—Ç PostgreSQL (supabase-db –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –ø–æ—Ä—Ç 5432)
          SUPABASE_PORT=$(docker port supabase-db 5432 2>/dev/null | grep -oE '[0-9]+$' || echo "")
          
          if [ -z "$SUPABASE_PORT" ]; then
            echo "‚ö†Ô∏è supabase-db port mapping not found directly"
            # –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —á–µ—Ä–µ–∑ docker ps
            SUPABASE_PORT=$(docker ps --format '{{.Names}} {{.Ports}}' | grep supabase-db | grep -oE '0\.0\.0\.0:[0-9]+->5432' | grep -oE ':[0-9]+' | tr -d ':' | head -1)
          fi
          
          echo "üìä Detected PostgreSQL port: ${SUPABASE_PORT:-NOT FOUND}"
          
          # –ï—Å–ª–∏ –ø–æ—Ä—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º 54322 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è Supabase)
          if [ -z "$SUPABASE_PORT" ]; then
            SUPABASE_PORT="54322"
            echo "‚ö†Ô∏è Using default port: $SUPABASE_PORT"
          fi
          
          # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º DATABASE_URL
          if [ -f .env ]; then
            # –ó–∞–º–µ–Ω—è–µ–º –ª—é–±–æ–π –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ö–æ—Å—Ç/–ø–æ—Ä—Ç
            if grep -qE "(supabase-db|:5432[^0-9])" .env; then
              sed -i "s|@supabase-db:5432|@172.17.0.1:${SUPABASE_PORT}|g" .env
              sed -i "s|@172.17.0.1:5432/|@172.17.0.1:${SUPABASE_PORT}/|g" .env
              echo "‚úÖ Fixed DATABASE_URL to use 172.17.0.1:${SUPABASE_PORT}"
            fi
          fi
          
          echo "üìã Current .env configuration:"
          grep -E "^(DATABASE_URL|OLLAMA_BASE_URL)=" .env | sed 's/:[^:@]*@/:***@/' || echo "No .env found"
      
      - name: Rebuild and restart services
        run: |
          cd ~/alpaca/services
          echo "üîÑ Rebuilding containers..."
          docker compose down
          docker compose build --no-cache
          docker compose up -d
          echo "‚úÖ Services restarted"
      
      - name: Show container status
        run: |
          echo "üìä Container status:"
          docker ps --format "table {{.Names}}\t{{.Status}}" | grep -E "alpaca|supabase" || true
      
      - name: Cleanup old images
        run: docker image prune -f
      
      - name: Health check
        run: |
          echo "‚è≥ Waiting for services to start..."
          sleep 15
          
          FAILED=0
          
          echo "üîç Checking admin-backend..."
          if curl -sf http://localhost:8080/health > /tmp/health_admin.json 2>&1; then
            echo " ‚úÖ OK"
          else
            echo " ‚ùå FAILED"
            docker logs alpaca-admin-backend-1 --tail 20 2>&1 || true
            FAILED=1
          fi
          
          echo "üîç Checking chat-backend..."
          if curl -sf http://localhost:8082/health > /tmp/health_chat.json 2>&1; then
            echo " ‚úÖ OK"
          else
            echo " ‚ùå FAILED"
            docker logs alpaca-chat-backend-1 --tail 20 2>&1 || true
            FAILED=1
          fi
          
          echo "üîç Checking filewatcher..."
          if curl -sf http://localhost:8081/health > /tmp/health_fw.json 2>&1; then
            echo " ‚úÖ OK"
          else
            echo " ‚ùå FAILED"
            docker logs alpaca-filewatcher-1 --tail 20 2>&1 || true
            FAILED=1
          fi
          
          echo "üîç Checking mcp-server..."
          if curl -sf http://localhost:8083/docs > /dev/null 2>&1; then
            echo " ‚úÖ OK"
          else
            echo " ‚ùå FAILED"
            docker logs alpaca-mcp-server-1 --tail 20 2>&1 || true
            FAILED=1
          fi
          
          echo ""
          echo "üìä Container status:"
          docker ps --format "table {{.Names}}\t{{.Status}}" | grep alpaca || true
          
          if [ $FAILED -eq 1 ]; then
            echo "‚ö†Ô∏è Some services failed health check"
            exit 1
          fi
          
          echo "‚úÖ All services healthy!"
