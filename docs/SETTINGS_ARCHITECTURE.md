# Архитектура настроек ALPACA

## Принципы организации

### 1. settings.py - Основной файл конфигурации
**Содержит:**
- ✅ Все параметры приложения с значениями по умолчанию
- ✅ Пути к файлам и директориям
- ✅ Интервалы, таймауты, лимиты
- ✅ Списки расширений, паттернов
- ✅ Feature flags (RUN_TESTS_ON_START)
- ✅ URL сервисов (без паролей)
- ✅ Параметры логирования
- ✅ Бизнес-логика и правила

**Не содержит:**
- ❌ Пароли и токены
- ❌ Connection strings с паролями
- ❌ API ключи и секреты

### 2. .env - Только credentials
**Содержит:**
- ✅ DATABASE_URL (с паролем)
- ✅ USERNAME/PASSWORD для сервисов
- ✅ API ключи и токены
- ✅ Секретные ключи (SECRET_KEY, JWT_SECRET)

**Не содержит:**
- ❌ Пути (MONITORED_PATH)
- ❌ Интервалы (SCAN_INTERVAL_SECONDS)
- ❌ Размеры (FILE_MAX_SIZE)
- ❌ Списки (ALLOWED_EXTENSIONS)
- ❌ Любые не-секретные настройки

## Почему так?

### Преимущества:
1. **Безопасность**: .env минимален, меньше риск утечки
2. **Прозрачность**: Все настройки видны в settings.py
3. **Версионирование**: settings.py в git, .env в .gitignore
4. **Удобство**: Изменения конфигурации не требуют редактирования .env
5. **Defaults**: Всегда понятны значения по умолчанию

### Проблемы старого подхода:
- .env превращался в свалку всех настроек
- Непонятно какие значения по умолчанию
- Риск случайно закоммитить credentials
- Сложно отличить секреты от обычных настроек

## Примеры

### ✅ Правильно

**settings.py:**
```python
class Settings(BaseSettings):
    # Credentials из .env
    DATABASE_URL: str  # Обязательно из .env
    
    # Конфигурация здесь
    MONITORED_PATH: str = "/home/alpaca/monitored_folder"
    SCAN_INTERVAL_SECONDS: int = 10
    FILE_MAX_SIZE: int = 10485760
    ALLOWED_EXTENSIONS: str = ".docx,.pdf,.txt"
```

**.env:**
```bash
# Только credentials
DATABASE_URL=postgresql://user:password@host:5432/db
USERNAME_SUPABASE_DASHBOARD=admin
PASSWORD_SUPABASE_DASHBOARD=secret123
```

### ❌ Неправильно

**.env:**
```bash
# Плохо - смешивание секретов и настроек
DATABASE_URL=postgresql://user:password@host:5432/db
MONITORED_PATH=/home/alpaca/folder  # ❌ Не секрет!
SCAN_INTERVAL_SECONDS=10  # ❌ Не секрет!
FILE_MAX_SIZE=10485760  # ❌ Не секрет!
```

## Как использовать

### Изменение конфигурации

**Для разработки:**
```python
# settings.py
RUN_TESTS_ON_START: bool = True  # Включить тесты
SCAN_INTERVAL_SECONDS: int = 5   # Быстрее сканировать
```

**Для production:**
```python
# settings.py
RUN_TESTS_ON_START: bool = False
SCAN_INTERVAL_SECONDS: int = 30
```

### Переопределение через env (редко нужно)
```bash
# При необходимости можно переопределить
SCAN_INTERVAL_SECONDS=60 python worker.py
```

### Добавление новой настройки

**Если это НЕ секрет:**
1. Добавьте в settings.py с разумным значением по умолчанию
2. Документируйте назначение

**Если это секрет:**
1. Объявите в settings.py без значения: `API_KEY: str`
2. Добавьте в .env: `API_KEY=secret_value`
3. Добавьте в .env.example: `API_KEY=your_api_key_here`

## Миграция существующих настроек

Если находите настройку в .env, которая не является секретом:
1. Удалите из .env
2. Добавьте в settings.py со значением по умолчанию
3. Проверьте что всё работает

## Контрольный список

При добавлении новой настройки спросите себя:

- [ ] Это пароль/токен/ключ? → .env
- [ ] Это конфигурационный параметр? → settings.py
- [ ] Есть ли разумное значение по умолчанию? → settings.py
- [ ] Это будет часто меняться? → settings.py
- [ ] Это специфично для окружения? → Зависит от типа
  - Credentials → .env
  - Пути/настройки → settings.py с возможностью override через env

## Инструмент для AI ассистента

Когда пользователь просит добавить настройку, следуйте алгоритму:

1. **Определите тип:**
   - Секрет/пароль/токен → только .env
   - Всё остальное → settings.py (с возможностью override из env)

2. **Добавьте в правильное место:**
   - settings.py: с типом, значением по умолчанию, комментарием
   - .env: только если это секрет

3. **Документируйте:**
   - В коде: понятное имя переменной и комментарий
   - В .env.example: если секрет

4. **Проверьте:**
   - Не дублируется ли настройка
   - Есть ли логическая группировка с другими настройками
   - Понятно ли назначение из имени
