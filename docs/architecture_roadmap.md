# Дорожная карта по снижению связанности

## Обзор
Цель — упорядочить точку сборки зависимостей, разнести контракты домена и реализацию application-слоя, сделать выбор эмбеддера конфигурируемым и очистить устаревшие совместимые API. Ниже перечислены поэтапные шаги с ожидаемыми результатами и критериями готовности.

---

## Этап 1. Bootstrap зависимостей
**Задача:** вынести создание всех сервисов и use-case'ов из `main.py` в отдельный модуль (например, `core/application/bootstrap.py`).

- **Действия**
  - Создать фабрики: `build_repository(settings)`, `build_ingest_pipeline(settings)`, `build_worker(settings)`.
  - `main.py` превращается в тонкий слой, который вызывает bootstrap и запускает worker.
- **Результат**: любая часть проекта (тесты, CLI) может получить готовые сервисы из одного места.
- **Критерий завершения**: модуль `main.py` содержит только запуск, а тесты используют bootstrap-фабрики вместо прямого импорта глобалов.

## Этап 2. Чёткие границы domain/application
**Задача:** domain объявляет интерфейсы и фасады, application предоставляет реализации.

- **Действия**
  - В `core/domain/document_processing/embedders` оставить Protocol/интерфейс и контракты.
  - В application-слое реализовать регистрацию «активной» функции через bootstrap (см. Этап 1), а не через `__init__`.
  - Документировать правило импорта: внешний код импортирует только доменный фасад.
- **Результат**: доменный слой перестаёт «протягивать» реализацию, связь направлена сверху вниз.
- **Критерий**: ни один модуль за пределами application не импортирует `core/application/document_processing/...` напрямую.

## Этап 3. Конфигурируемый embedder
**Задача:** переключение между Ollama/LangChain/иными реализациями без правок кода.

- **Действия**
  - Добавить в `settings.py` параметр `EMBEDDER_BACKEND` (например, `"custom"`, `"langchain"`).
  - В bootstrap-фабрике выбирать реализацию по настройке.
  - При необходимости добавить фичефлаги (включение langchain зависит от установленных пакетов).
- **Результат**: смена реализации происходит через переменные окружения.
- **Критерий**: достаточно изменить `EMBEDDER_BACKEND`, чтобы worker использовал другую функцию.

## Этап 4. Совместимость и тесты
**Задача:** убрать устаревшие compat-слои после миграции тестов.

- **Действия**
  - Проверить внешние потребители `main.process_file` / `ingest_pipeline`; если их нет, удалить или переместить в `compat.py`.
  - Обновить тесты, чтобы они использовали bootstrap-фабрики (или `ProcessFileEvent`) напрямую.
- **Результат**: `main.py` больше не содержит бизнес-логику и совместимых обёрток.
- **Критерий**: тесты проходят без импорта устаревших функций, а coverage подтверждает использование новых путей.

## Этап 5. Документация и операционные практики
**Задача:** зафиксировать архитектурные правила и упростить поддержку.

- **Действия**
  - Добавить README в пакеты `core/domain/document_processing` и `core/application/document_processing` с описанием ответственности.
  - Обновить `docs/SETTINGS_ARCHITECTURE.md`, описав новые флаги и bootstrap.
  - Прописать в `scripts/команды.md` короткие инструкции: «как сменить embedder», «как использовать bootstrap в тестах».
- **Результат**: разработчики понимают, где и как менять реализацию, не заходя в исходники.
- **Критерий**: документация отражает текущее состояние и проходит ревью команды.

---

## Контроль прогресса
| Этап | Статус | Ключевые метрики |
|------|--------|------------------|
| Bootstrap зависимостей | ☐ | `main.py` < 100 строк, все сервисы строятся в bootstrap |
| Domain vs Application | ☐ | Нет прямых импортов `core/application/...` вне bootstrap |
| Конфигурируемый embedder | ☐ | Переключение по `EMBEDDER_BACKEND` без правок кода |
| Совместимость и тесты | ☐ | Удалён устаревший API, тесты через новые фасады |
| Документация | ☐ | README/SETTINGS обновлены |

При необходимости добавляйте подпункты и статусы прямо в этом файле по мере выполнения.